#!/usr/bin/env python3

import os
import subprocess
import sys
from pathlib import Path
from datetime import datetime

ROOT = Path(__file__).resolve().parent
DATA = ROOT / "data"
REPORT = ROOT / "benchmark.md"
SCRIPT = ROOT / "scripts" / "bench_backends.py"

PY = sys.executable or "python3"


def run(cmd):
    print("$", " ".join(cmd))
    subprocess.run(cmd, check=True)


def ensure_data():
    DATA.mkdir(exist_ok=True)
    p1 = DATA / "example.csv"
    if not p1.exists():
        # reuse the simple generator via python
        import csv, random
        random.seed(42)
        with p1.open("w", newline="") as f:
            w = csv.writer(f)
            w.writerow(["a", "b", "cat"])
            for _ in range(200000):
                from random import randint, choice
                w.writerow([randint(-1000, 1000), randint(-1000, 1000), choice(["x", "y", "z"])])
    p2 = DATA / "example_small.csv"
    if not p2.exists():
        import csv
        with p2.open("w", newline="") as f:
            w = csv.writer(f)
            w.writerow(["a", "b", "cat"])
            for a, b, c in [(1, 2, "x"), (-1, 5, "y"), (3, -2, "z")]:
                w.writerow([a, b, c])
    return p1, p2


def main():
    ensure_data()
    # Start fresh report with a title and timestamp
    ts = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    with REPORT.open("w") as f:
        f.write(f"# unipandas benchmarks\n\nGenerated at: {ts}\n\n")

    # Scenario 1
    out1 = ROOT / "benchmark_s1.md"
    cmd1 = [
        PY,
        str(SCRIPT),
        str(DATA / "example.csv"),
        "--assign",
        "--query",
        "a > 0",
        "--groupby",
        "cat",
        "--code-file",
        "examples.py",
        "--md-out",
        str(out1),
    ]
    run(cmd1)
    with REPORT.open("a") as f:
        f.write("\n## Scenario 1: example.csv assign+query+groupby\n\n")
        f.write(out1.read_text())

    # Scenario 2
    out2 = ROOT / "benchmark_s2.md"
    cmd2 = [
        PY,
        str(SCRIPT),
        str(DATA / "example_small.csv"),
        "--assign",
        "--query",
        "a >= 0",
        "--groupby",
        "cat",
        "--code-file",
        "examples.py",
        "--md-out",
        str(out2),
    ]
    run(cmd2)
    with REPORT.open("a") as f:
        f.write("\n## Scenario 2: example_small.csv assign+query+groupby\n\n")
        f.write(out2.read_text())

    print("\nAggregated report:", REPORT)


if __name__ == "__main__":
    sys.exit(main())
